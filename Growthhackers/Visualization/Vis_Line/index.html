<!DOCTYPE html>
<html lang="kr">

<head>
    <meta charset="utf-8">
    <title>D3 페이지 템플릿</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
        * {
            font-family: sans-serif;
        }

        .hover {
            fill-opacity: .4;
        }

        .x.axis .tick text {
            stroke: none;
        }

        path.series {
            fill: none;
            stroke-width: 2px;
        }

        .point {
            cursor: pointer;

        }

        .tooltip {
            font-size: 12px;
            stroke: none;
        }
    </style>
</head>

<body>
    <div>
        <button id="left">
            << </button>
                <button id="right"> >> </button>
    </div>
    <script type="text/javascript">
        d3.json('sample.line2.json').then(function (data) {
            var w = 240,
                h = 120;
            var margin = {
                top: 10,
                right: 10,
                bottom: 20,
                left: 10
            };
            var innerW = w - margin.right - margin.left,
                innerH = h - margin.top - margin.bottom;
            var cursor = 0,
                offset = 10,
                max = 20;

            var svg = d3.select('body').append('svg')
                .attr('width', w)
                .attr('height', h * 3)
                .append('g')
            svg.append('clipPath')
                .attr('id', 'bar-clip')
                .append('rect')
                .attr('x', -margin.left)
                .attr('y', -margin.top)
                .attr('width', innerW + margin.left)
                .attr('height', h + margin.top);


            var nest = d3.nest()
                .key(function (d) {
                    return d.c
                })
                .key(function (d) {
                    return d.x
                })
                .sortKeys(function (a, b) {
                    return parseInt(a) - parseInt(b);
                }) //x의 오름차순으로 정리한다.
                .rollup(function (values) {
                    return d3.mean(values, function (d) {
                        return d.y;
                    })
                })
                .entries(data);


            var x = d3.scalePoint()
                .domain(d3.range(cursor + 1, max + 1))
                .range([0, innerW * 2]);
            var y = d3.scaleLinear()
                .domain([0, 100])
                .range([innerH, 0])
                .clamp(true);
            var c = d3.scaleOrdinal()
                .domain(nest.map(function (d) {
                    return d.key
                }))
                .range(d3.schemeCategory10);
            var xAxis = d3.axisBottom(x)
                .tickSize(0)
                .tickPadding(4);

            var line = d3.line()
                .x(function (d) {
                    return x(parseInt(d.key));
                })
                .y(function (d) {
                    return y(d.value);
                })

            var region = svg.selectAll('.region')
                .data(function (d) {
                    return nest
                }, function (d) {
                    return d.key
                })
                .enter().append('g')
                .attr('class', 'region')
                .attr('fill', function (d) {
                    return c(d.key)
                })
                .attr('stroke', function (d) {
                    return c(d.key)
                })
                .attr('clip-path', 'url(#bar-clip)')
                .attr('transform', function (d, i) {
                    return 'translate(' + [margin.left, margin.top + h * i] + ')';
                })
                .append('g'); //clip-path 이동을 막기위해 추가 

            region.append('g')
                .attr('class', 'x axis')
                .attr('transform', 'translate(' + [0, innerH] + ')')
                .call(xAxis);

            region.append('path')
                .datum(function (d) {
                    return d.values
                })
                .attr('class', 'series')
                .attr('d', line)
console.log(data)
            var point = region.selectAll('.point')
                .data(function (d) {
                    return d.values
                })
                .enter().append('circle')
                .attr('class', 'point')
                .attr('cx', function (d) {
                    return x(parseInt(d.key));
                })
                .attr('cy', function (d) {
                    return y(d.value);
                })
                .attr('r', 2);

            point.on('mouseenter', function (d) {
                var tooltip = region.selectAll('.tooltip')
                    .data(function (p) {
                        return p.values.filter(function (v) {
                            return v.key === d.key;
                        })
                    })
                tooltip.enter().append('text')
                    .attr('class', 'tooltip')
                    .merge(tooltip)
                    .attr('x', function (d) {
                        return x(parseInt(d.key));
                    })
                    .attr('y', function (d) {
                        return y(d.value);
                    })
                    .attr('dx', '.35em')
                    .attr('dy', '-.35em')
                    .style('visibility', 'visible')
                    .text(function (d) {
                        return d.value
                    });
            }).on('mouseleave', function (d) {
                var tooltip = region.selectAll('.tooltip')
                    .style('visibility', 'hidden')
            });

            d3.select('body').selectAll('button')
                .on('click', function () {
                    var _id = d3.select(this).attr('id');
                    var m = 0;
                    if (_id == 'left') {
                        if (cursor - 1 >= 0) {
                            cursor -= 1;
                            region
                                .transition()
                                .attr('transform', 'translate(' + (-x.step() * cursor) + ')') //point 간격 X 이동한 양
                        }
                    } else {
                        if (cursor + 1 <= max - offset) {
                            cursor += 1;
                            region
                                .transition()
                                .ease(d3.easeLinear)
                                .attr('transform', 'translate(' + (-x.step() * cursor) + ')')
                        }
                    }

                });
        }); //json
    </script>
</body>

</html>